{% extends "base.html" %}
{% load i18n %}
{% block title %}{% trans "D√©gradation de l'√©cole" %}{% endblock %}
{% block main %}

<!-- ===================== MODAL (SANS BOOTSTRAP) ===================== -->
<style>
  .m-overlay{
    position:fixed; inset:0; background:rgba(0,0,0,.45);
    display:none; align-items:center; justify-content:center;
    padding:16px; z-index:9999;
  }
  .m-overlay.show{ display:flex; }

  .m-box{
    width:min(980px, 100%);
    max-height: calc(100vh - 24px);
    background:#fff;
    border-radius:10px;
    overflow:hidden;
    box-shadow:0 25px 80px rgba(0,0,0,.25);
    display:flex; flex-direction:column;
  }
  .m-head{
    padding:14px 18px;
    border-bottom:1px solid #e7e7e7;
    display:flex; align-items:center; justify-content:space-between;
  }
  .m-head h5{ margin:0; font-weight:600; font-size:18px; }
  .m-close{
    width:34px; height:34px; border-radius:8px;
    border:1px solid #ddd; background:#fff; cursor:pointer;
    font-size:18px; line-height:1;
  }
  .m-body{ padding:14px 18px; overflow:auto; }

  .m-grid{
    display:grid;
    grid-template-columns: 1fr 1fr 1fr;
    gap:12px;
  }
  .m-col-2{ grid-column: span 2; }
  .m-col-3{ grid-column: 1 / -1; }

  .m-field label{
    display:block; font-size:12px; color:#555; margin:0 0 6px;
  }
  .req{ color:#d11; font-weight:700; }

  .m-input, .m-select, .m-text{
    width:100%;
    border:1px solid #d9d9d9;
    border-radius:4px;
    padding:10px 10px;
    outline:none;
    font-size:13px;
    background:#fff;
  }
  .m-text{ min-height:90px; resize:vertical; }

  .m-foot{
    padding:12px 18px;
    border-top:1px solid #e7e7e7;
    display:flex; justify-content:flex-end; gap:10px;
    background:#fafafa;
  }
  .m-btn{
    border:1px solid #d0d0d0;
    background:#fff;
    padding:8px 14px;
    border-radius:6px;
    cursor:pointer;
    font-weight:600;
  }
  .m-btn.primary{
    background:#3f2bbf;
    border-color:#3f2bbf;
    color:#fff;
  }

  .m-msg{
    display:none;
    margin:0 0 12px;
    padding:10px 12px;
    border-radius:6px;
    border:1px solid #ddd;
    background:#f6f6f6;
    font-size:13px;
  }
  .m-msg.show{ display:block; }
  .m-msg.err{ border-color:#f0b4b4; background:#fff1f1; }
  .m-msg.ok{ border-color:#bfe8c9; background:#f0fff4; }

  /* + button decision */
  .decision-row{
    display:flex; gap:8px; align-items:center;
  }
  .plus-btn{
    width:38px; height:38px;
    border-radius:6px;
    border:1px solid #d9d9d9;
    background:#fff;
    cursor:pointer;
    font-weight:900;
    font-size:18px;
  }
  .hidden{ display:none !important; }

  @media (max-width: 900px){
    .m-grid{ grid-template-columns: 1fr 1fr; }
  }
  @media (max-width: 600px){
    .m-grid{ grid-template-columns: 1fr; }
    .m-col-2, .m-col-3{ grid-column:auto; }
  }
</style>

<div class="container-fluid">
  <div class="card">
    <div class="card-body">

      <div class="d-flex justify-content-between align-items-center">
        <h5 class="mb-0">{% trans "D√©gradation commise" %}</h5>

        <div class="d-flex gap-2">
          <button class="btn btn-primary" id="btnOpenModal">{% trans "Ajouter" %}</button>
          <a class="btn btn-success" href="{% url 'degradation_export_excel' %}?q={{ q|urlencode }}">{% trans "Excel" %}</a>
          <a class="btn btn-danger" href="{% url 'degradation_export_pdf' %}?q={{ q|urlencode }}" target="_blank">{% trans "PDF" %}</a>
        </div>
      </div>

      <hr>

      <div class="d-flex justify-content-end mb-2">
        <form method="get" class="d-flex gap-2">
          <input type="text" name="q" value="{{ q }}" class="form-control" style="max-width:220px"
                 placeholder="{% trans 'Rechercher ici' %}">
          <button class="btn btn-outline-secondary" type="submit">{% trans "OK" %}</button>
        </form>
      </div>

      <div class="table-responsive">
        <table class="table table-hover align-middle">
          <thead class="table-light">
            <tr>
              <th>{% trans "Nom de l'√©l√®ve" %}</th>
              <th>{% trans "La liste des classes" %}</th>
              <th>{% trans "D√©gradation commise" %}</th>
              <th>{% trans "D√©cision prise" %}</th>
              <th>{% trans "Date" %}</th>
              <th style="width:120px">{% trans "Actions" %}</th>
            </tr>
          </thead>

          <tbody id="tbodyDeg">
            {% for d in degradations %}
            <tr data-id="{{ d.id }}">
              <td>{{ d.eleve.nom }}</td>
              <td>{% if d.eleve.classe %}{{ d.eleve.classe.nom }}{% endif %}</td>
              <td>{{ d.degradation_commise|truncatechars:30 }}</td>
              <td>{{ d.decision_affichee }}</td>
              <td>{{ d.date|date:"d-m-Y" }}</td>
              <td>
                <button class="btn btn-sm btn-link text-primary btnEdit" type="button" title="{% trans 'Modifier' %}">‚úé</button>
                <button class="btn btn-sm btn-link text-danger btnDelete" type="button" title="{% trans 'Supprimer' %}">üóë</button>
              </td>
            </tr>
            {% empty %}
            <tr><td colspan="6" class="text-center text-muted">{% trans "Aucun enregistrement √† afficher" %}</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

    </div>
  </div>
</div>

<!-- ===================== MODAL ===================== -->
<div class="m-overlay" id="modalOverlay" aria-hidden="true">
  <div class="m-box" role="dialog" aria-modal="true">
    <div class="m-head">
      <h5 id="modalTitle">{% trans "Ajouter une d√©gradation" %}</h5>
      <button class="m-close" id="btnCloseModal" type="button">√ó</button>
    </div>

    <div class="m-body">
      <div class="m-msg" id="modalMsg"></div>
      <input type="hidden" id="d_id" value="">

      <div class="m-grid">
        <div class="m-field">
          <label>{% trans "Niveaux" %} <span class="req">*</span></label>
          <select class="m-select" id="niveau_id">
            <option value="">{% trans "Select..." %}</option>
            {% for n in niveaux %}
              <option value="{{ n.id }}">{{ n.nom }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="m-field">
          <label>{% trans "La liste des classes" %} <span class="req">*</span></label>
          <select class="m-select" id="classe_id">
            <option value="">{% trans "Select..." %}</option>
          </select>
        </div>

        <div class="m-field">
          <label>{% trans "Nom de l'√©l√®ve" %} <span class="req">*</span></label>
          <select class="m-select" id="eleve_id">
            <option value="">{% trans "Select..." %}</option>
          </select>
        </div>

        <div class="m-field m-col-3">
          <label>{% trans "D√©gradation commise" %} <span class="req">*</span></label>
          <textarea class="m-text" id="degradation_commise" placeholder="{% trans 'D√©gradation commise' %}"></textarea>
        </div>

        <div class="m-field m-col-2">
          <label>{% trans "D√©cision prise" %} <span class="req">*</span></label>
          <div class="decision-row">
            <select class="m-select" id="decision_prise">
              {% for k, v in DECISIONS %}
                {% if k != "autre" %}
                  <option value="{{ k }}">{{ v }}</option>
                {% endif %}
              {% endfor %}
              <option value="autre">{% trans "Autre (personnalis√©e)" %}</option>
            </select>
            <button class="plus-btn" id="btnDecisionPlus" type="button" title="{% trans 'Ajouter autre d√©cision' %}">+</button>
          </div>
        </div>

        <div class="m-field hidden" id="decisionAutreWrap">
          <label>{% trans "Autre d√©cision" %} <span class="req">*</span></label>
          <input class="m-input" id="decision_autre" type="text" placeholder="{% trans 'Ex: Nettoyage + r√©paration...' %}">
        </div>

        <div class="m-field">
          <label>{% trans "Date" %} <span class="req">*</span></label>
          <input class="m-input" type="date" id="d_date">
        </div>
      </div>
    </div>

    <div class="m-foot">
      <button class="m-btn" type="button" id="btnCancel">{% trans "Fermer" %}</button>
      <button class="m-btn primary" type="button" id="btnSave">{% trans "Sauvegarder" %}</button>
    </div>
  </div>
</div>

<script>
  // ---------- CSRF ----------
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }
  const CSRFTOKEN = getCookie('csrftoken');

  // ---------- Modal UI ----------
  const overlay = document.getElementById("modalOverlay");
  const msgBox = document.getElementById("modalMsg");
  const modalTitle = document.getElementById("modalTitle");

  function showMsg(text, type){
    msgBox.className = "m-msg show " + (type === "ok" ? "ok" : "err");
    msgBox.textContent = text || "";
  }
  function clearMsg(){
    msgBox.className = "m-msg";
    msgBox.textContent = "";
  }
  function openModal(){
    clearMsg();
    overlay.classList.add("show");
    overlay.setAttribute("aria-hidden","false");
  }
  function closeModal(){
    overlay.classList.remove("show");
    overlay.setAttribute("aria-hidden","true");
  }

  document.getElementById("btnOpenModal").addEventListener("click", () => {
    resetForm();
    modalTitle.textContent = "{% trans 'Ajouter une d√©gradation' %}";
    openModal();
  });
  document.getElementById("btnCloseModal").addEventListener("click", closeModal);
  document.getElementById("btnCancel").addEventListener("click", closeModal);
  overlay.addEventListener("click", (e) => { if (e.target === overlay) closeModal(); });
  document.addEventListener("keydown", (e) => { if (e.key === "Escape") closeModal(); });

  // ---------- chained selects ----------
  const niveauSel = document.getElementById("niveau_id");
  const classeSel = document.getElementById("classe_id");
  const eleveSel  = document.getElementById("eleve_id");

  async function loadClasses(niveauId){
    classeSel.innerHTML = '<option value="">{% trans "Select..." %}</option>';
    eleveSel.innerHTML  = '<option value="">{% trans "Select..." %}</option>';
    if(!niveauId) return;
    const res = await fetch("{% url 'ajax_classes_by_niveau_degradation' %}?niveau_id=" + encodeURIComponent(niveauId));
    const data = await res.json();
    if(!data.ok) return;
    for(const it of data.items){
      const opt = document.createElement("option");
      opt.value = it.id;
      opt.textContent = it.text;
      classeSel.appendChild(opt);
    }
  }

  async function loadEleves(classeId){
    eleveSel.innerHTML  = '<option value="">{% trans "Select..." %}</option>';
    if(!classeId) return;
    const res = await fetch("{% url 'ajax_eleves_by_classe_degradation' %}?classe_id=" + encodeURIComponent(classeId));
    const data = await res.json();
    if(!data.ok) return;
    for(const it of data.items){
      const opt = document.createElement("option");
      opt.value = it.id;
      opt.textContent = it.text;
      eleveSel.appendChild(opt);
    }
  }

  niveauSel.addEventListener("change", () => loadClasses(niveauSel.value));
  classeSel.addEventListener("change", () => loadEleves(classeSel.value));

  // ---------- decision + input ----------
  const decisionSel = document.getElementById("decision_prise");
  const decisionWrap = document.getElementById("decisionAutreWrap");
  const decisionAutre = document.getElementById("decision_autre");
  const btnPlus = document.getElementById("btnDecisionPlus");

  function syncDecisionUI(){
    const isAutre = (decisionSel.value === "autre");
    decisionWrap.classList.toggle("hidden", !isAutre);
    if(!isAutre) decisionAutre.value = "";
  }

  decisionSel.addEventListener("change", syncDecisionUI);

  btnPlus.addEventListener("click", () => {
    decisionSel.value = "autre";
    syncDecisionUI();
    decisionAutre.focus();
  });

  // ---------- reset ----------
  function resetForm(){
    document.getElementById("d_id").value = "";
    niveauSel.value = "";
    classeSel.innerHTML = '<option value="">{% trans "Select..." %}</option>';
    eleveSel.innerHTML = '<option value="">{% trans "Select..." %}</option>';
    document.getElementById("degradation_commise").value = "";
    decisionSel.value = "avertissement";
    decisionAutre.value = "";
    document.getElementById("d_date").value = "";
    syncDecisionUI();
    clearMsg();
  }

  // ---------- edit ----------
  document.querySelectorAll(".btnEdit").forEach(btn => {
    btn.addEventListener("click", async (e) => {
      const tr = e.target.closest("tr");
      const id = tr.getAttribute("data-id");
      resetForm();
      modalTitle.textContent = "{% trans 'Modifier une d√©gradation' %}";
      openModal();

      const url = "{% url 'degradation_json' 1 %}".replace("/1/", "/" + id + "/");
      const res = await fetch(url);
      const data = await res.json();
      if(!data.ok){
        showMsg("{% trans 'Erreur chargement.' %}", "err");
        return;
      }

      document.getElementById("d_id").value = data.id;

      niveauSel.value = data.niveau_id || "";
      await loadClasses(niveauSel.value);
      classeSel.value = data.classe_id || "";
      await loadEleves(classeSel.value);
      eleveSel.value = data.eleve_id || "";

      document.getElementById("degradation_commise").value = data.degradation_commise || "";
      decisionSel.value = data.decision_prise || "avertissement";
      decisionAutre.value = data.decision_autre || "";
      syncDecisionUI();
      document.getElementById("d_date").value = data.date || "";
    });
  });

  // ---------- delete ----------
  document.querySelectorAll(".btnDelete").forEach(btn => {
    btn.addEventListener("click", async (e) => {
      const tr = e.target.closest("tr");
      const id = tr.getAttribute("data-id");
      if(!confirm("{% trans 'Supprimer cet enregistrement ?' %}")) return;

      const url = "{% url 'degradation_delete' 1 %}".replace("/1/", "/" + id + "/");
      const res = await fetch(url, { method:"POST", headers:{ "X-CSRFToken": CSRFTOKEN }});
      const data = await res.json().catch(()=>({}));
      if(!res.ok || !data.ok){
        alert((data && data.message) ? data.message : "{% trans 'Erreur suppression' %}");
        return;
      }
      tr.remove();
    });
  });

  // ---------- save ----------
  document.getElementById("btnSave").addEventListener("click", async () => {
    clearMsg();

    const payload = {
      id: document.getElementById("d_id").value || null,
      niveau_id: niveauSel.value,
      classe_id: classeSel.value,
      eleve_id: eleveSel.value,
      degradation_commise: document.getElementById("degradation_commise").value,
      decision_prise: decisionSel.value,
      decision_autre: decisionAutre.value,
      date: document.getElementById("d_date").value,
    };

    try{
      const res = await fetch("{% url 'degradation_save' %}", {
        method:"POST",
        headers:{
          "Content-Type":"application/json",
          "X-CSRFToken": CSRFTOKEN
        },
        body: JSON.stringify(payload)
      });

      const data = await res.json().catch(()=>({}));
      if(!res.ok || !data.ok){
        showMsg((data && data.message) ? data.message : "{% trans 'Erreur sauvegarde.' %}", "err");
        return;
      }

      showMsg(data.message || "OK", "ok");
      setTimeout(() => window.location.reload(), 600);

    }catch(err){
      showMsg("{% trans 'Erreur r√©seau.' %}", "err");
    }
  });

  syncDecisionUI();
</script>

{% endblock %}
