{% extends "base.html" %}
{% block main %}
{% include "_taps.html" %}

<style>
  /* ====== BARRE FILTRE (alignée comme capture) ====== */
  .filters-card{
    background:#ffffff;
    border:1px solid rgba(0,0,0,.06);
    border-radius:14px;
    padding:18px;
    box-shadow: 0 10px 24px rgba(0,0,0,.10);
  }
  .filters-card .form-label{
    font-weight:700;
    font-size:13px;
    margin-bottom:6px;
    color:#111827;
  }
  .filters-actions{
    display:flex;
    justify-content:flex-end;
    gap:12px;
    align-items:center;
    margin-top:14px;
  }

  /* ====== BULLETIN A4 (écriture visible) ====== */
  .bulletin-paper{
    width: 210mm;
    min-height: 297mm;
    margin: 0 auto 14px auto;
    background:#fff;
    border:1px solid #e5e7eb;
    border-radius:12px;
    padding: 10mm 10mm 8mm 10mm;
    box-sizing:border-box;

    /* IMPORTANT: forcer texte noir */
    color:#111 !important;
  }

  /* empêcher images énormes */
  .bulletin-paper img{
    max-width:100% !important;
    height:auto !important;
  }

  .bulletin-header{
    display:grid;
    grid-template-columns: 1.25fr 1fr 0.75fr;
    gap: 8mm;
    align-items:start;
  }

  .logo-img{
    width: 16mm !important;
    height: 16mm !important;
    object-fit:contain !important;
    display:inline-block;
  }

  .ecole-block{
    font-size:12px;
    line-height:1.45;
    color:#111;
  }

  .title-block{
    text-align:center;
    font-size:12px;
    line-height:1.55;
    color:#111;
  }
  .title-block h3{
    font-size:14px;
    margin:0 0 2mm 0;
    font-weight:800;
    color:#111;
  }

  .right-block{
    text-align:right;
    font-size:12px;
    color:#111;
  }

  .photo-circle{
    width:24mm;
    height:24mm;
    border-radius:999px;
    background:#f3f4f6;
    border:1px solid #d1d5db;
    overflow:hidden;
    display:inline-flex;
    align-items:center;
    justify-content:center;
  }
  .photo-circle img{
    width:100% !important;
    height:100% !important;
    object-fit:cover !important;
  }

  .sep{
    border-top:1px solid #111;
    opacity:.25;
    margin:4mm 0;
  }

  /* tableau bulletin : texte noir + header bleu */
  .tbl{
    width:100%;
    border-collapse:collapse;
    font-size:11px;
    color:#111;
  }
  .tbl th,.tbl td{
    border:1px solid #111;
    padding:4px 5px;
    vertical-align:middle;
    color:#111;
  }
  .tbl thead th{
    background:#2f95d9;        /* comme ta capture (bleu) */
    color:#fff !important;
    font-weight:800;
  }
  .tbl .subhead th{
    background:#2f95d9;
    color:#fff !important;
    font-weight:800;
  }
  .tfoot td{
    font-weight:800;
    color:#111;
  }

  .bottom-grid{
    margin-top:4mm;
    display:grid;
    grid-template-columns: 1fr 0.36fr;
    gap:0;
  }
  .bottom-left,.bottom-right{
    border:1px solid #111;
    border-top:none;
    padding:0;
    font-size:11px;
    color:#111;
  }
  .bottom-right{
    display:flex;
    align-items:center;
    justify-content:center;
    text-align:center;
    font-weight:800;
    padding: 6mm 2mm;
  }

  .bottom-table{
    width:100%;
    border-collapse:collapse;
  }
  .bottom-table td{
    border-top:1px solid #111;
    border-right:1px solid #111;
    padding:5px;
    color:#111;
  }
  .bottom-table td:last-child{ border-right:none; }

  .council-title{
    border-top:1px solid #111;
    padding:6px;
    font-weight:800;
    text-align:center;
    color:#111;
  }

  /* PRINT */
  @media print{
    .filters-card, .nav, .navbar, .btn, .filters-actions{ display:none !important; }
    .bulletin-paper{
      border:none !important;
      border-radius:0 !important;
      margin:0 !important;
      page-break-after:always;
      padding: 8mm 8mm 6mm 8mm;
    }
    body{ background:#fff !important; }
  }
</style>

<!-- ============ FILTRE ============ -->
<div class="filters-card mb-3">
  <form method="get" id="filterForm">
    <div class="row g-3 align-items-end">

      <div class="col-12 col-md-2">
  <label class="form-label">Année scolaire*</label>
  <select class="form-select" name="annee" onchange="document.getElementById('filterForm').submit()">
    {% for a in annees %}
      <option value="{{ a.id }}" {% if annee_id == a.id|stringformat:"s" %}selected{% endif %}>
        {{ a.nom }}
      </option>
    {% endfor %}
  </select>
</div>


      <div class="col-12 col-md-2">
        <label class="form-label">Niveaux*</label>
        <select class="form-select" name="niveau" onchange="document.getElementById('filterForm').submit()">
          <option value="">--</option>
          {% for n in niveaux %}
            <option value="{{ n.id }}" {% if niveau_id|stringformat:"s" == n.id|stringformat:"s" %}selected{% endif %}>{{ n.nom }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="col-12 col-md-3">
        <label class="form-label">La liste des classes*</label>
        <select class="form-select" name="classe" onchange="document.getElementById('filterForm').submit()">
          <option value="">--</option>
          {% for c in classes %}
            <option value="{{ c.id }}" {% if classe_id|stringformat:"s" == c.id|stringformat:"s" %}selected{% endif %}>
              {{ c.nom }} - {{ c.niveau.nom }}
            </option>
          {% endfor %}
        </select>
      </div>

      <div class="col-12 col-md-2">
        <label class="form-label">Période*</label>
        <select class="form-select" name="periode">
          <option value="">--</option>
          {% for p in periodes %}
            <option value="{{ p.id }}" {% if periode_id|stringformat:"s" == p.id|stringformat:"s" %}selected{% endif %}>{{ p.nom }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="col-12 col-md-3">
        <label class="form-label">Élève*</label>
        <select class="form-select" name="eleve">
          <option value="all" {% if eleve_id == "all" %}selected{% endif %}>All</option>
          {% for e in eleves %}
            <option value="{{ e.id }}" {% if eleve_id|stringformat:"s" == e.id|stringformat:"s" %}selected{% endif %}>{{ e.nom }}</option>
          {% endfor %}
        </select>
      </div>

    </div>

    <div class="filters-actions">
      <button class="btn btn-success px-4" type="submit">Filtrer</button>
      <button class="btn btn-primary px-4" type="button" onclick="window.print()">Imprimer</button>
    </div>
  </form>
</div>

<!-- ============ BULLETINS ============ -->
<div id="printArea">
  {% for b in bulletins %}
  <div class="bulletin-paper">

    <div class="bulletin-header">
      <!-- LEFT -->
      <div class="ecole-block">
        <div style="display:flex; gap:8px; align-items:flex-start;">
          {% if ecole.logo %}
            <img class="logo-img" src="{{ ecole.logo.url }}" alt="logo">
          {% else %}
            <div class="logo-img" style="display:flex;align-items:center;justify-content:center;border:1px solid #ddd;border-radius:6px;">Logo</div>
          {% endif %}
          <div>
            <div style="font-weight:900;">{{ ecole.nom }}</div>
            <div>Téléphone: {{ ecole.telephone|default:"-" }}</div>
            <div>E-mail: {{ ecole.email|default:"-" }}</div>
            <div>Année scolaire: {{ annee.nom }}</div>
          </div>
        </div>
      </div>

      <!-- CENTER -->
      <div class="title-block">
        <h3>Bulletin Du {{ periode.nom }}</h3>
        <div style="font-weight:800;">{{ b.eleve.identifiant|default:"" }}</div>
        <div style="font-weight:900;">{{ b.eleve.nom }}</div>
        <div>Né(e): {{ b.eleve.date_naissancce }}</div>
        <div>{{ b.eleve.classe.niveau.nom }} - {{ b.eleve.classe.nom }}</div>
        <div>Professeur Principal: -</div>
      </div>

      <!-- RIGHT -->
      <div class="right-block">
        <div>Le : {{ today }}</div>
        <div style="margin-top:6mm;">
          <span class="photo-circle">
            {% if b.eleve.photo %}
              <img src="{{ b.eleve.photo.url }}" alt="photo">
            {% endif %}
          </span>
        </div>
      </div>
    </div>

    <div class="sep"></div>

    <table class="tbl">
      <thead>
        <tr>
          <th rowspan="2" style="width:18%;">matière</th>
          <th rowspan="2" style="width:24%;">Enseignant</th>
          <th rowspan="2" style="width:10%;">NB Note</th>
          <th rowspan="2" style="width:10%;">Rang</th>
          <th colspan="2" style="width:20%; text-align:center;">Moyennes</th>
          <th rowspan="2" style="width:18%;">Appréciation</th>
        </tr>
        <tr class="subhead">
          <th>Élève</th>
          <th>Classe</th>
        </tr>
      </thead>

      <tbody>
        {% for l in b.data.lignes %}
        <tr>
          <td style="font-weight:900;">{{ l.matiere|upper }}</td>
          <td>{{ l.enseignant }}</td>
          <td style="text-align:center;">{{ l.nb_note }}</td>
          <td style="text-align:center;">{{ l.rang }}</td>
          <td style="text-align:center;">{{ l.moy_eleve }}</td>
          <td style="text-align:center;">{{ l.moy_classe }}</td>
          <td>{{ l.appreciation }}</td>
        </tr>
        {% endfor %}
      </tbody>

      <tfoot class="tfoot">
        <tr>
          <td colspan="3" style="text-align:center;">Moyenne Générale</td>
          <td style="text-align:center;">-</td>
          <td style="text-align:center;">{{ b.data.moyenne_generale }}</td>
          <td style="text-align:center;">-</td>
          <td></td>
        </tr>
      </tfoot>
    </table>

    <div class="bottom-grid">
      <div class="bottom-left">
        <table class="bottom-table">
          <tr>
             <td style="width:20%;">Absences</td>
            <td>{{ b.data.absences_heures }} heure(s)</td>
          </tr>
          <tr>
            <td>Appréciation globale</td>
            <td>{{ b.data.appreciation_globale }}</td>
          </tr>
          <tr>
            <td>Absences &amp; Conduite</td>
            <td></td>
          </tr>
        </table>
        <div class="council-title">APPRECIATION DU CONSEIL DE CLASSE</div>
      </div>

      <div class="bottom-right">
        SIGNATURE &amp; CACHET<br><br>
        le(a) Principal(e)
      </div>
    </div>

  </div>
  {% endfor %}

  {% if not bulletins %}
    <div class="alert alert-info">
      Choisis une <strong>classe</strong> et une <strong>période</strong>, puis filtre.
    </div>
  {% endif %}
</div>

{% endblock %}
