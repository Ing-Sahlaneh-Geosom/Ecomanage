{% extends 'base.html' %}
{% load static i18n %}
{% block title %}{% trans "Cartes scolaires" %}{% endblock %}
{% block main %}

{% get_current_language as LANGUAGE_CODE %}
{% if LANGUAGE_CODE == "ar" %}
<style>
  body{ direction:rtl; text-align:right; }
</style>
{% endif %}

<style>
  /* =========================
     PAGE + FILTRES
     ========================= */
  .cs-page, .cs-page *{ color:#111; }
  .cs-page{ background:#f5f7fb; padding:12px; }
  .cs-wrap{
    background:#fff; border:1px solid #e7e7e7; border-radius:10px;
    padding:18px 18px 8px; box-shadow:0 4px 14px rgba(0,0,0,.08);
  }
  .cs-top-title{ font-weight:800; margin-bottom:14px; font-size:16px; }
  .cs-row{ display:flex; gap:16px; align-items:flex-end; flex-wrap:wrap; }
  .cs-field{ flex:1; min-width:260px; }
  .cs-field label{ font-size:13px; font-weight:800; margin-bottom:6px; display:block; }
  .cs-actions{ display:flex; gap:10px; align-items:flex-end; }
  .btn-filter{ width:56px; height:44px; border-radius:8px; display:inline-flex; align-items:center; justify-content:center; }
  .cs-print{ margin-top:14px; display:flex; justify-content:flex-end; gap:10px; }

  .no-data{ text-align:center; padding:32px 10px 24px; }
  .no-data small{ color:#666; }


:root{
  --card-w: 85.6mm;
  --card-h: 54mm;
  --ink: rgba(255,255,255,.96);
  --ink2: rgba(255,255,255,.84);
  --edge: rgba(255,255,255,.18);
}

/* paire recto/verso */
.ssx-pair{
  display:flex;
  gap:14px;
  justify-content:center;
  align-items:flex-start;
  flex-wrap:wrap;
  margin:0 0 18px 0;
}

/* carte */
.ssx-card{
  width:var(--card-w);
  height:var(--card-h);
  border-radius:14px;
  overflow:hidden;
  position:relative;
  border:1px solid var(--edge);
  box-shadow:0 18px 46px rgba(0,0,0,.28);
  background:
    radial-gradient(1200px 360px at 30% 25%, rgba(65,210,255,.26), transparent 55%),
    radial-gradient(900px 300px at 78% 62%, rgba(255,255,255,.10), transparent 62%),
    linear-gradient(135deg, #04162e, #083f7d);
  font-family: system-ui, -apple-system, Segoe UI, Roboto, "DejaVu Sans", Arial, sans-serif;
  color: var(--ink);
}
.ssx-card *{ box-sizing:border-box; }

/* Ã©toiles */
.ssx-card::before{
  content:"";
  position:absolute; inset:0;
  background-image:
    radial-gradient(1px 1px at 10% 20%, rgba(255,255,255,.85) 50%, transparent 51%),
    radial-gradient(1px 1px at 20% 80%, rgba(255,255,255,.55) 50%, transparent 51%),
    radial-gradient(1px 1px at 34% 40%, rgba(255,255,255,.70) 50%, transparent 51%),
    radial-gradient(1px 1px at 56% 16%, rgba(255,255,255,.60) 50%, transparent 51%),
    radial-gradient(1px 1px at 70% 34%, rgba(255,255,255,.65) 50%, transparent 51%),
    radial-gradient(1px 1px at 86% 72%, rgba(255,255,255,.55) 50%, transparent 51%),
    radial-gradient(1px 1px at 92% 22%, rgba(255,255,255,.45) 50%, transparent 51%);
  opacity:.9;
  pointer-events:none;
  z-index:0;
}

/* vagues + glow premium */
.ssx-wave{
  position:absolute; inset:-22px -32px;
  background:
    linear-gradient(120deg, transparent 34%, rgba(120,240,255,.22) 46%, rgba(255,255,255,.10) 54%, transparent 68%),
    radial-gradient(1000px 280px at 18% 78%, rgba(120,240,255,.26), transparent 60%),
    radial-gradient(1000px 280px at 86% 56%, rgba(255,255,255,.14), transparent 62%);
  opacity:.95;
  pointer-events:none;
  z-index:1;
}

/* light trails (gros rendu premium) */
.ssx-trails{
  position:absolute; inset:-18px -28px;
  background:
    radial-gradient(900px 140px at 12% 72%, rgba(120,240,255,.30), transparent 62%),
    radial-gradient(900px 120px at 80% 46%, rgba(255,255,255,.12), transparent 65%),
    linear-gradient(115deg, transparent 38%, rgba(255,255,255,.08) 48%, rgba(120,240,255,.20) 54%, rgba(255,255,255,.06) 60%, transparent 74%);
  opacity:.92;
  mix-blend-mode: screen;
  pointer-events:none;
  z-index:2;
}

/* biseau */
.ssx-bevel{
  position:absolute; inset:0;
  border-radius:14px;
  box-shadow:
    inset 0 1px 0 rgba(255,255,255,.22),
    inset 0 -1px 0 rgba(0,0,0,.20);
  pointer-events:none;
  z-index:3;
}

/* bande mÃ©tal haut */
.ssx-silver{
  position:absolute;
  left:-18px; right:-18px; top:8px;
  height:12mm;
  background: linear-gradient(90deg,
    rgba(255,255,255,.08),
    rgba(255,255,255,.26),
    rgba(120,240,255,.18),
    rgba(255,255,255,.08)
  );
  opacity:.82;
  transform: skewX(-10deg);
  border-top:1px solid rgba(255,255,255,.14);
  border-bottom:1px solid rgba(255,255,255,.10);
  pointer-events:none;
  z-index:4;
}

.ssx-inner{
  position:relative;
  z-index:5;
  height:100%;
  padding:10px;
}

/* ===== RECTO ===== */

/* plaque logo */
.ssx-brand{
  position:absolute;
  left:10px;
  top:10px;
  width:46mm;
  height:20mm;
  z-index:6;
}
.ssx-brand .plate{
  width:100%;
  height:100%;
  border-radius:10px;
  background: rgba(255,255,255,.10);
  border:1px solid rgba(255,255,255,.16);
  box-shadow: 0 10px 22px rgba(0,0,0,.18);
  padding:4px 6px;
  display:flex;
  align-items:center;
}
.ssx-brand img{
  width:100%;
  height:100%;
  object-fit:contain;
  filter: drop-shadow(0 2px 10px rgba(0,0,0,.35));
}

/* titre capsule */
.ssx-title{
  position:absolute;
  top:12px;
  left:10px; right:10px;
  padding-left:48mm;
  display:flex;
  align-items:center;
  justify-content:center;
  gap:6px;
  z-index:6;
}
.ssx-title .pill{
  padding:6px 12px;
  border-radius:999px;
  font-weight:900;
  font-size:12px;
  letter-spacing:1px;
  text-transform:uppercase;
  color:var(--ink);
  background: linear-gradient(180deg, rgba(255,255,255,.20), rgba(255,255,255,.06));
  border:1px solid rgba(255,255,255,.18);
  text-shadow:0 2px 10px rgba(0,0,0,.25);
  white-space:nowrap;
}
.ssx-title svg{ width:12px; height:12px; opacity:.9; color:var(--ink); }

/* photo */
.ssx-photo{
  position:absolute;
  right:12px;
  top:16mm;
  width:32mm;
  height:38mm;
  border-radius:14px;
  padding:2.8px;
  background: linear-gradient(135deg, rgba(255,255,255,.95), rgba(255,255,255,.25), rgba(255,255,255,.85));
  box-shadow:0 12px 28px rgba(0,0,0,.20);
  z-index:6;
}
.ssx-photo .in{
  width:100%; height:100%;
  border-radius:12px;
  overflow:hidden;
  background: rgba(255,255,255,.06);
  border:1px solid rgba(255,255,255,.18);
}
.ssx-photo img{ width:100%; height:100%; object-fit:cover; }

/* lock photo */
.ssx-lock{
  position:absolute;
  right:6px;
  top:44mm;
  width:13mm;
  height:13mm;
  border-radius:50%;
  background: radial-gradient(circle at 30% 30%, rgba(110,230,255,.35), rgba(255,255,255,.10));
  border:1px solid rgba(255,255,255,.22);
  box-shadow:0 12px 24px rgba(0,0,0,.18);
  display:flex;
  align-items:center;
  justify-content:center;
  color:#fff;
  font-size:12px;
  z-index:7;
}

/* infos bas gauche */
.ssx-info{
  position:absolute;
  left:12px;
  bottom:10px;
  width:52mm;
  color:var(--ink);
  font-size:9.6px;
  line-height:1.35;
  text-shadow:0 2px 10px rgba(0,0,0,.22);
  z-index:6;
}
.ssx-name{
  font-weight:900;
  font-size:13px;
  margin-bottom:4px;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}
.ssx-row{
  display:grid;
  grid-template-columns: 22mm 1fr;
  gap:6px;
}
.ssx-lbl{ font-weight:800; opacity:.95; }
.ssx-val{ opacity:.98; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }

/* ===== VERSO ===== */
/* âœ… QR plus petit + plus haut = place pour texte dessous */
.ssx-qr{
  position:absolute;
  left:50%;
  top:11mm;
  transform:translateX(-50%);
  width:28mm;
  height:28mm;
  border-radius:14px;
  background: rgba(255,255,255,.10);
  border:1px solid rgba(255,255,255,.18);
  padding:2.4mm;
  box-shadow:
    0 14px 28px rgba(0,0,0,.22),
    0 0 0 2px rgba(120,240,255,.12),
    0 0 26px rgba(120,240,255,.22);
  z-index:6;
}
.ssx-qr .in{
  width:100%; height:100%;
  border-radius:10px;
  background:#fff;
  padding:5px;
  box-shadow: inset 0 0 0 1px rgba(0,0,0,.10);
}
.ssx-qr img{ width:100%; height:100%; object-fit:contain; }

/* âœ… lock collÃ© au QR (coin bas droit) */
.ssx-qrLock{
  position:absolute;
  left:calc(50% + 9mm);
  top:calc(11mm + 19mm);
  width:9mm;
  height:9mm;
  border-radius:50%;
  background: rgba(200,245,255,.95);
  border:1px solid rgba(0,0,0,.10);
  box-shadow:0 10px 18px rgba(0,0,0,.18);
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:10px;
  color:#1b2a3a;
  z-index:7;
}

/* âœ… texte sous QR (plus de chevauchement) */
.ssx-backText{
  position:absolute;
  left:10px; right:10px;
  top:39mm;              /* <-- clÃ© */
  text-align:center;
  z-index:6;
  text-shadow:0 2px 10px rgba(0,0,0,.22);
}
.ssx-backTitle{
  font-weight:900;
  font-size:11px;
  letter-spacing:.8px;
  text-transform:uppercase;
  color:var(--ink);
}
.ssx-backSub{
  margin-top:2px;
  font-size:9px;
  color:rgba(255,255,255,.92);
}
.ssx-backContact{
  margin-top:4px;
  font-size:8.7px;
  color:rgba(255,255,255,.90);
  white-space:nowrap;
}

/* directeur bas droite */
.ssx-director{
  position:absolute;
  right:10px;
  bottom:8px;
  color:rgba(255,255,255,.86);
  font-size:8.4px;
  z-index:6;
}

/* RTL : layout fixe, texte RTL propre */
html[dir="rtl"] .ssx-card{ direction:ltr; }
html[dir="rtl"] .rtl{
  direction:rtl;
  text-align:right;
  font-family:"DejaVu Sans", Tahoma, Arial, sans-serif;
}
html[dir="rtl"] .ssx-row{ grid-template-columns: 1fr 22mm; }
html[dir="rtl"] .ssx-lbl{ text-align:right; }




  /* =========================
     PRINT
     ========================= */
  @media print{
    body *{ visibility:hidden !important; }
    #printArea, #printArea *{ visibility:visible !important; }

    #printArea{
      position:absolute; left:0; top:0;
      width:100%;
      background:#fff !important;
      padding:0 !important;
      margin:0 !important;
    }

    /* 1 paire par ligne (A4) */
    .id-pair{ page-break-inside:avoid; break-inside:avoid; }

    /* Ã©viter que lâ€™imprimante change les couleurs */
    .id-card{
      -webkit-print-color-adjust: exact;
      print-color-adjust: exact;
      box-shadow:none !important;
    }

    @page{ margin:10mm; }
  }
</style>

<div class="cs-page">
  <div class="cs-wrap">

    <div class="cs-top-title">{% trans "Cartes scolaires" %}</div>

    <form method="get" class="cs-row" id="filterForm">
      <!-- NIVEAU -->
      <div class="cs-field">
        <label>{% trans "Niveaux" %} <span class="text-danger">*</span></label>
        <select id="niveau" name="niveau" class="form-select" required>
          <option value="">{% trans "SÃ©lectionner..." %}</option>
          {% for n in niveaux %}
            <option value="{{ n.id }}" {% if selected_niveau == n.id|stringformat:"s" %}selected{% endif %}>
              {{ n.nom }}
            </option>
          {% endfor %}
        </select>
      </div>

      <!-- CLASSE -->
      <div class="cs-field">
        <label>{% trans "Liste des classes" %} <span class="text-danger">*</span></label>
        <select id="classe" name="classe" class="form-select" required {% if not selected_niveau %}disabled{% endif %}>
          <option value="">{% trans "SÃ©lectionner..." %}</option>
          {% for c in classes %}
            <option value="{{ c.id }}" {% if selected_classe == c.id|stringformat:"s" %}selected{% endif %}>
              {{ c.nom }}
            </option>
          {% endfor %}
        </select>
      </div>

      <!-- Ã‰LÃˆVE -->
      <div class="cs-field">
        <label>{% trans "Ã‰lÃ¨ve" %}</label>
        <select id="eleve" name="eleve" class="form-select" {% if not selected_niveau %}disabled{% endif %}>
          <option value="">{% trans "SÃ©lectionner..." %}</option>
          <option value="all" {% if selected_eleve == "all" %}selected{% endif %}>
            {% trans "Tous les Ã©lÃ¨ves" %}
          </option>
        </select>
      </div>

      <div class="cs-actions">
        <button type="submit" class="btn btn-success btn-filter" title="{% trans 'Filtrer' %}">
          <i class="bi bi-sliders"></i>
        </button>
      </div>
    </form>

    <div class="cs-print">
      <button type="button" class="btn btn-primary" id="btnPrint">
        <i class="bi bi-printer"></i> {% trans "Imprimer" %}
      </button>
    </div>

    <!-- =========================
         ZONE IMPRIMABLE
         ========================= -->
    <div id="printArea" class="cards-area">
      {% for e in eleves %}
     

 



<div class="ssx-pair">

  <!-- =============== RECTO =============== -->
  <div class="ssx-card">
    <div class="ssx-wave"></div>
    <div class="ssx-trails"></div>
    <div class="ssx-bevel"></div>
    <div class="ssx-silver"></div>

    <div class="ssx-inner">

      <div class="ssx-brand">
        <div class="plate">
          <img src="{% static 'img/IMG-20260210-WA0001.jpg' %}" alt="Logo">
        </div>
      </div>

      <div class="ssx-title">
        <span class="pill">{% trans "Carte scolaire" %}</span>
        <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path d="M2 8.5C7.5 3.5 16.5 3.5 22 8.5" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          <path d="M5 12C8.5 8.8 15.5 8.8 19 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" opacity=".9"/>
          <path d="M8.2 15.2C10.1 13.7 13.9 13.7 15.8 15.2" stroke="currentColor" stroke-width="2" stroke-linecap="round" opacity=".85"/>
          <circle cx="12" cy="18" r="1.6" fill="currentColor"/>
        </svg>
      </div>

      <div class="ssx-photo">
        <div class="in">
          {% if e.photo %}
            <img src="{{ e.photo.url }}" alt="Photo">
          {% else %}
            <img src="{% static 'img/user-placeholder.png' %}" alt="Photo">
          {% endif %}
        </div>
      </div>

      <div class="ssx-lock">ðŸ”’</div>

      <div class="ssx-info rtl">
        <div class="ssx-name">{{ e.nom|default:"-" }}</div>

        <div class="ssx-row">
          <div class="ssx-lbl">{% trans "Matricule" %}:</div>
          <div class="ssx-val">{{ e.identifiant|default:"-" }}</div>
        </div>

        <div class="ssx-row">
          <div class="ssx-lbl">{% trans "Classe" %}:</div>
          <div class="ssx-val">{{ e.classe.nom|default:"-" }}</div>
        </div>

        <div class="ssx-row">
          <div class="ssx-lbl">{% trans "NÃ©(e) le" %}:</div>
          <div class="ssx-val">{{ e.date_naissancce|default:"-" }}</div>
        </div>

        <div class="ssx-row">
          <div class="ssx-lbl">{% trans "AnnÃ©e scolaire" %}:</div>
          <div class="ssx-val">{{ e.annee_scolaire|default:"-" }}</div>
        </div>
      </div>

    </div>
  </div>

  <!-- =============== VERSO =============== -->
  <div class="ssx-card">
    <div class="ssx-wave"></div>
    <div class="ssx-trails"></div>
    <div class="ssx-bevel"></div>
    <div class="ssx-silver"></div>

    <div class="ssx-inner">

      <div class="ssx-qr">
        <div class="in">
          {% if e.qr_code %}
            <img src="{{ e.qr_code.url }}" alt="QR">
          {% else %}
            <img src="{% static 'img/qr-placeholder.png' %}" alt="QR">
          {% endif %}
        </div>
      </div>

      <div class="ssx-qrLock">ðŸ”’</div>

      <div class="ssx-backText rtl">
        <div class="ssx-backTitle">{% trans "Scannez ce QR code" %}</div>
        <div class="ssx-backSub">{% trans "VÃ©rifiez l'authenticitÃ© sur" %} <b>www.smartschool.edu</b></div>
        <div class="ssx-backContact">
          <b>{% trans "TÃ©l." %}</b> {{ e.ecole.telephone|default:"-" }}
          &nbsp; â€¢ &nbsp;
          <b>{% trans "Email" %}</b> {{ e.ecole.email|default:"-" }}
        </div>
      </div>

      <div class="ssx-director rtl">{% trans "Le Directeur" %}</div>

    </div>
  </div>

</div>






      {% empty %}
        <div class="no-data">
          <strong>{% trans "Aucune donnÃ©e trouvÃ©e" %}</strong> ðŸ˜”<br>
          <small>{% trans "Choisissez un niveau et une classe puis cliquez sur filtrer." %}</small>
        </div>
      {% endfor %}
    </div>

  </div>
</div>

<script>
const TXT_SELECT = "{% trans 'SÃ©lectionner...' %}";
const TXT_ALL    = "{% trans 'Tous les Ã©lÃ¨ves' %}";

document.addEventListener("DOMContentLoaded", function () {
  const niveau = document.getElementById("niveau");
  const classe = document.getElementById("classe");
  const eleve  = document.getElementById("eleve");

  const urlClasses = "{% url 'ajax_classes_par_niveau' %}";
  const urlEleves  = "{% url 'ajax_eleves_par_classe' %}";

  function resetClasse(){ classe.innerHTML = `<option value="">${TXT_SELECT}</option>`; }
  function resetEleve(){
    eleve.innerHTML = `
      <option value="">${TXT_SELECT}</option>
      <option value="all">${TXT_ALL}</option>
    `;
  }

  niveau.addEventListener("change", function () {
    const nid = this.value || "";
    resetClasse(); resetEleve();

    if(!nid){
      classe.disabled = true;
      eleve.disabled = true;
      return;
    }
    classe.disabled = false;
    eleve.disabled = false;

    fetch(`${urlClasses}?niveau_id=${encodeURIComponent(nid)}`, { cache: "no-store" })
      .then(res => res.json())
      .then(data => {
        data.forEach(c => {
          const opt = document.createElement("option");
          opt.value = c.id;
          opt.textContent = c.nom;
          classe.appendChild(opt);
        });
      })
      .catch(() => {});
  });

  classe.addEventListener("change", function () {
    const cid = this.value || "";
    const nid = niveau.value || "";
    resetEleve();

    if(!cid) return;

    fetch(`${urlEleves}?classe_id=${encodeURIComponent(cid)}&niveau_id=${encodeURIComponent(nid)}`, { cache: "no-store" })
      .then(res => res.json())
      .then(data => {
        data.forEach(e => {
          const opt = document.createElement("option");
          opt.value = e.id;
          opt.textContent = e.nom;
          eleve.appendChild(opt);
        });
      })
      .catch(() => {});
  });

  document.getElementById("btnPrint").addEventListener("click", function(){
    window.print();
  });
});
</script>

{% endblock %}
