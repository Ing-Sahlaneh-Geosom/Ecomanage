{% extends "base.html" %}
{% block title %}Envoyer message{% endblock %}
{% block main %}

<div class="container-fluid px-4 py-4">
  <div class="row justify-content-center">
    <div class="col-lg-7">

      <div class="d-flex justify-content-between align-items-center mb-3">
        <h5 class="fw-bold m-0">✉️ Envoyer un message (Prof)</h5>
        <a href="{% url 'read_message' %}" class="btn btn-light btn-sm">⬅ Retour</a>
      </div>

      {% if messages %}
        {% for m in messages %}
          <div class="alert alert-{{ m.tags }} py-2">{{ m }}</div>
        {% endfor %}
      {% endif %}

      <div class="card shadow-sm">
        <div class="card-body">

          <form method="post">
            {% csrf_token %}

            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label fw-semibold">Envoyer à</label>
                <select class="form-select" name="target" id="targetSelect" required>
                  <option value="">-- Choisir --</option>
                  <option value="eleve">Parent d'un élève</option>
                  <option value="classe">Parents d'une classe</option>
                  <option value="toutes">Parents de toutes mes classes</option>
                </select>
              </div>

              <div class="col-md-6 d-none" id="classeBox">
                <label class="form-label fw-semibold">Classe</label>
                <select class="form-select" name="classe_id" id="classeSelect">
                  <option value="">-- Choisir --</option>
                  {% for c in prof_classes %}
                    <option value="{{ c.id }}">{{ c }}</option>
                  {% endfor %}
                </select>
              </div>

              <div class="col-md-12 d-none" id="eleveBox">
                <label class="form-label fw-semibold">Élève (pour cibler son parent)</label>
                <select class="form-select" name="eleve_id" id="eleveSelect">
                  <option value="">Choisir d'abord une classe...</option>
                </select>
              </div>

              <div class="col-md-12">
                <label class="form-label fw-semibold">Sujet</label>
                <input class="form-control" name="sujet" required>
              </div>

              <div class="col-md-12">
                <label class="form-label fw-semibold">Message</label>
                <textarea class="form-control" name="contenu" rows="5" required></textarea>
              </div>
            </div>

            <div class="d-flex justify-content-end mt-3">
              <button class="btn btn-primary" type="submit">Envoyer</button>
            </div>
          </form>

        </div>
      </div>

    </div>
  </div>
</div>

<script>
  const targetSelect = document.getElementById("targetSelect");
  const classeBox = document.getElementById("classeBox");
  const eleveBox = document.getElementById("eleveBox");
  const classeSelect = document.getElementById("classeSelect");
  const eleveSelect = document.getElementById("eleveSelect");

  const urlEleves = "{% url 'ajax_eleves_by_classe' %}";

  function hideAll(){
    classeBox.classList.add("d-none");
    eleveBox.classList.add("d-none");
    classeSelect.required = false;
    eleveSelect.required = false;
  }

  targetSelect.addEventListener("change", async ()=>{
    hideAll();
    const v = targetSelect.value;

    if(v === "classe"){
      classeBox.classList.remove("d-none");
      classeSelect.required = true;
    }

    if(v === "eleve"){
      classeBox.classList.remove("d-none");
      eleveBox.classList.remove("d-none");
      classeSelect.required = true;
      eleveSelect.required = true;
    }
  });

  classeSelect.addEventListener("change", async ()=>{
    eleveSelect.innerHTML = `<option value="">Chargement...</option>`;
    const classe_id = classeSelect.value;
    if(!classe_id){
      eleveSelect.innerHTML = `<option value="">Choisir d'abord une classe...</option>`;
      return;
    }

    const res = await fetch(urlEleves + `?classe_id=${classe_id}`, {cache:"no-store"});
    const data = await res.json();

    eleveSelect.innerHTML = `<option value="">-- Choisir --</option>`;
    (data.items || []).forEach(it=>{
      const o = document.createElement("option");
      o.value = it.id; o.textContent = it.text;
      eleveSelect.appendChild(o);
    });
  });
</script>

{% endblock %}
