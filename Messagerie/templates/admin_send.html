{% extends "base.html" %}
{% block title %}Envoyer message{% endblock %}
{% block main %}

<div class="container-fluid px-4 py-4">
  <div class="row justify-content-center">
    <div class="col-lg-8">

      <div class="d-flex justify-content-between align-items-center mb-3">
        <h5 class="fw-bold m-0">✉️ Envoyer un message (Admin/Secrétaire)</h5>
        <a href="{% url 'read_message' %}" class="btn btn-light btn-sm">⬅ Retour</a>
      </div>

      {% if messages %}
        {% for m in messages %}
          <div class="alert alert-{{ m.tags }} py-2">{{ m }}</div>
        {% endfor %}
      {% endif %}

      <div class="card shadow-sm">
        <div class="card-body">

          <form method="post" id="sendForm">
            {% csrf_token %}

            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label fw-semibold">Envoyer à</label>
                <select class="form-select" name="target" id="targetSelect" required>
                  <option value="">-- Choisir --</option>
                  <option value="parent_one">Un parent</option>
                  <option value="classe">Parents d'une classe</option>
                  <option value="niveau">Parents d'un niveau</option>
                  <option value="tous">Tous les parents</option>
                </select>
              </div>

              <div class="col-md-6 d-none" id="classeBox">
                <label class="form-label fw-semibold">Classe</label>
                <select class="form-select" name="classe_id" id="classeSelect">
                  <option value="">-- Choisir --</option>
                </select>
              </div>

              <div class="col-md-6 d-none" id="niveauBox">
                <label class="form-label fw-semibold">Niveau</label>
                <select class="form-select" name="niveau_id" id="niveauSelect">
                  <option value="">-- Choisir --</option>
                  {% for n in niveaux %}
                    <option value="{{ n.id }}">{{ n.nom }}</option>
                  {% endfor %}
                </select>
              </div>

              <div class="col-md-6 d-none" id="parentBox">
                <label class="form-label fw-semibold">Parent</label>
                <select class="form-select" name="parent_id" id="parentSelect">
                  <option value="">Chargement...</option>
                </select>
              </div>

              <div class="col-md-12">
                <label class="form-label fw-semibold">Sujet</label>
                <input class="form-control" name="sujet" required>
              </div>

              <div class="col-md-12">
                <label class="form-label fw-semibold">Message</label>
                <textarea class="form-control" name="contenu" rows="5" required></textarea>
              </div>
            </div>

            <div class="d-flex justify-content-end mt-3">
              <button class="btn btn-primary" type="submit">Envoyer</button>
            </div>
          </form>

        </div>
      </div>

    </div>
  </div>
</div>

<script>
  const targetSelect = document.getElementById("targetSelect");
  const classeBox = document.getElementById("classeBox");
  const niveauBox = document.getElementById("niveauBox");
  const parentBox = document.getElementById("parentBox");

  const classeSelect = document.getElementById("classeSelect");
  const niveauSelect = document.getElementById("niveauSelect");
  const parentSelect = document.getElementById("parentSelect");

  const urlClasses = "{% url 'ajax_classes' %}";
  const urlParents = "{% url 'ajax_parents_by_scope' %}";

  function hideAll(){
    classeBox.classList.add("d-none");
    niveauBox.classList.add("d-none");
    parentBox.classList.add("d-none");
    classeSelect.required = false;
    niveauSelect.required = false;
    parentSelect.required = false;
  }

  async function loadClasses(){
    const res = await fetch(urlClasses, {cache:"no-store"});
    const data = await res.json();
    classeSelect.innerHTML = `<option value="">-- Choisir --</option>`;
    (data.items || []).forEach(it=>{
      const o = document.createElement("option");
      o.value = it.id; o.textContent = it.text;
      classeSelect.appendChild(o);
    });
  }

  async function loadParents(scope){
    let qs = `?scope=${scope}`;
    if(scope === "classe") qs += `&classe_id=${classeSelect.value}`;
    if(scope === "niveau") qs += `&niveau_id=${niveauSelect.value}`;

    parentSelect.innerHTML = `<option value="">Chargement...</option>`;
    const res = await fetch(urlParents + qs, {cache:"no-store"});
    const data = await res.json();

    parentSelect.innerHTML = `<option value="">-- Choisir --</option>`;
    (data.items || []).forEach(it=>{
      const o = document.createElement("option");
      o.value = it.id; o.textContent = it.text;
      parentSelect.appendChild(o);
    });
  }

  // init classes list
  loadClasses();

  targetSelect.addEventListener("change", async ()=>{
    hideAll();
    const v = targetSelect.value;

    if(v === "parent_one"){
      parentBox.classList.remove("d-none");
      parentSelect.required = true;
      await loadParents("tous");
    }
    if(v === "classe"){
      classeBox.classList.remove("d-none");
      parentBox.classList.remove("d-none");
      classeSelect.required = true;
      parentSelect.required = true;
      await loadParents("classe");
    }
    if(v === "niveau"){
      niveauBox.classList.remove("d-none");
      parentBox.classList.remove("d-none");
      niveauSelect.required = true;
      parentSelect.required = true;
      await loadParents("niveau");
    }
  });

  classeSelect.addEventListener("change", async ()=>{
    if(!parentBox.classList.contains("d-none")){
      await loadParents("classe");
    }
  });

  niveauSelect.addEventListener("change", async ()=>{
    if(!parentBox.classList.contains("d-none")){
      await loadParents("niveau");
    }
  });
</script>

{% endblock %}
