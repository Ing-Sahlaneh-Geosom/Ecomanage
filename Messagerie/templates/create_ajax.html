{% extends "base.html" %}
{% load i18n %}

{% block title %}{% trans "Envoyer une ressource" %}{% endblock %}

{% block main %}

<style>
  .rtl { direction: rtl; }
  .rtl .top-row { flex-direction: row-reverse; }
</style>

<div class="container-fluid px-4 py-3 {% if request.LANGUAGE_CODE == 'ar' %}rtl{% endif %}">

  <div class="d-flex m-3">
    <a class="btn btn-sm btn-outline-secondary" href="{% url 'ressources' %}">X</a>
    <h5 class="fw-bold mx-4 text-dark">{% trans "Envoyer une ressource" %}</h5>
  </div>

  <div style="background-color: white;" class="card text-light">
    <div class="card-body">
      <form method="POST" enctype="multipart/form-data" class="row g-3">
        {% csrf_token %}

        <div class="col-md-6">
          <label class="form-label fw-bold text-dark" for="{{ form.professeur.id_for_label }}">
            {% trans "Enseignant" %}
          </label>
          {{ form.professeur }}
          {% if form.professeur.errors %}
            <div class="text-danger small text-dark">{{ form.professeur.errors|striptags }}</div>
          {% endif %}
        </div>

        <div class="col-md-6">
          <label class="form-label fw-bold text-dark" for="{{ form.matier.id_for_label }}">
            {% trans "Matières" %}
          </label>
          {{ form.matier }}
          <div class="small text-muted d-none text-dark" id="loadingMatieres">{% trans "Chargement…" %}</div>

          <!-- ✅ corrigé: id + class -->
          <div class="small text-danger d-none text-dark" id="matierError">{% trans "Erreur de chargement." %}</div>

          {% if form.matier.errors %}
            <div class="text-danger small text-dark">{{ form.matier.errors|striptags }}</div>
          {% endif %}
        </div>

        <div class="col-md-6">
          <label class="form-label fw-bold text-dark" for="{{ form.fichier.id_for_label }}">
            {% trans "Fichier" %}
          </label>
          {{ form.fichier }}
          {% if form.fichier.errors %}
            <div class="text-danger small text-dark">{{ form.fichier.errors|striptags }}</div>
          {% endif %}
        </div>

        <div class="col-md-6">
          
          <label class="form-label fw-bold text-dark" for="{{ form.description.id_for_label }}">
            {% trans "description" %}
          </label>
          {{ form.description }}
          {% if form.description.errors %}
            <div class="text-danger small text-dark">{{ form.description.errors|striptags }}</div>
          {% endif %}
        </div>

        <div class="col-12 d-flex justify-content-end gap-2">
          <button class="btn btn-success" type="submit">{% trans "Sauvegarder" %}</button>
        </div>

      </form>
    </div>
  </div>

</div>

<script>
  const professeurSelect = document.getElementById("{{ form.professeur.auto_id }}");
  const matierSelect = document.getElementById("{{ form.matier.auto_id }}");

  const loading = document.getElementById("loadingMatieres");
  const errorBox = document.getElementById("matierError");

  // ✅ Traductions utilisées dans JS
  const OPT_DEFAULT = "{% trans 'Sélectionner...' %}";

  // ✅ même URL que la page (une seule url)
  const SAME_URL = "{% url 'ressource_create' %}";

  function setLoading(on){ loading.classList.toggle("d-none", !on); }
  function setError(on){ errorBox.classList.toggle("d-none", !on); }

  function resetMatier(){
    matierSelect.innerHTML = `<option value="">${OPT_DEFAULT}</option>`;
  }

  async function loadMatieres(profId){
    setError(false);

    if(!profId){ resetMatier(); return; }

    setLoading(true);
    matierSelect.disabled = true;

    try{
      const url = new URL(SAME_URL, window.location.origin);
      url.searchParams.set("ajax", "matieres");
      url.searchParams.set("professeur_id", profId);

      const res = await fetch(url.toString(), {
        headers: { "X-Requested-With": "XMLHttpRequest" }
      });

      if(!res.ok) throw new Error("bad");
      matierSelect.innerHTML = await res.text();
    }catch(e){
      resetMatier();
      setError(true);
    }finally{
      matierSelect.disabled = false;
      setLoading(false);
    }
  }

  professeurSelect.addEventListener("change", (e) => loadMatieres(e.target.value));

  // Si prof déjà choisi (après erreur validation)
  if (professeurSelect.value) loadMatieres(professeurSelect.value);
</script>

{% endblock %}
