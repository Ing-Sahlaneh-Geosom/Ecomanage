{% extends "base.html" %}
{% load i18n %}
{% block title %}{% trans "Saisie absences par mois" %}{% endblock %}
{% block main %}

<style>
  .wrap{background:#fff;border:1px solid #eef1f5;border-radius:10px;padding:18px;}
  .tabs{display:flex;gap:28px;border-bottom:1px solid #eef1f5;margin-bottom:18px;}
  .tabs a{padding:10px 0;text-decoration:none;color:#222;font-weight:600;}
  .tabs a.active{color:#24b36b;border-bottom:2px solid #24b36b;margin-bottom:-1px;}

  .title{font-size:20px;font-weight:700;margin:12px 0 18px;color:#111;}

  .filters{display:grid;grid-template-columns: 1fr 1fr 1fr 220px;gap:18px;align-items:end;}
  .f-label{font-weight:700;margin-bottom:6px;color:#111;}
  .req{color:#e74c3c}

  .btn-filter{background:#3bc67a;border:none;color:#fff;border-radius:8px;padding:12px 16px;font-weight:800;}
  .btn-filter:hover{filter:brightness(.98);}

  .print-row{display:flex;justify-content:flex-end;margin:14px 0;}
  .btn-print{background:#2d74ff;border:none;color:#fff;border-radius:10px;padding:10px 16px;font-weight:800;}

  .table thead th{background:#d8effb !important;color:#111;}
  .table td,.table th{vertical-align:middle;}
  .col-num{width:40px}
  .col-eleve{min-width:280px}
  .col-classe{min-width:170px}

  @media print{
    .navbar{display: none;}
    .no-print{display:none!important;}
    .wrap{border:none;}
  }

  /* RTL (arabe) */
  html[dir="rtl"] .filters { direction: rtl; }
  html[dir="rtl"] .print-row { justify-content: flex-start; }
</style>

<div class="wrap">

  <div class="tabs no-print">
    <a href="#" class="active">{% trans "Voir les présences par mois" %}</a>
  </div>

  <form method="get" class="no-print" id="filterForm">
    <div class="filters">

      <div>
        <div class="f-label">{% trans "Niveaux" %}<span class="req">*</span></div>
        <select class="form-select" name="niveau" id="niveauSelect" required>
          <option value="">{% trans "—" %}</option>
          {% for n in niveaux %}
            <option value="{{ n.id }}" {% if niveau_id|add:"" == n.id|add:"" %}selected{% endif %}>{{ n.nom }}</option>
          {% endfor %}
        </select>
      </div>

      <div>
        <div class="f-label">{% trans "La liste des classes" %}<span class="req">*</span></div>
        <select class="form-select" name="classe" id="classeSelect" required>
          <option value="">{% trans "—" %}</option>
          {% for c in classes %}
            <option value="{{ c.id }}" data-niveau="{{ c.niveau_id }}" {% if classe_id|add:"" == c.id|add:"" %}selected{% endif %}>
              {{ c.nom }}
            </option>
          {% endfor %}
        </select>
      </div>

      <div>
        <div class="f-label">{% trans "Période" %}<span class="req">*</span></div>
        <select class="form-select" name="periode" required>
          <option value="">{% trans "—" %}</option>
          {% for p in periodes %}
            <option value="{{ p.id }}" {% if periode_id|add:"" == p.id|add:"" %}selected{% endif %}>{{ p.nom }}</option>
          {% endfor %}
        </select>
      </div>

      <button class="btn-filter" type="submit">{% trans "Filtrer" %}</button>
    </div>
  </form>

  <div class="print-row no-print">
    <button type="button" class="btn-print" onclick="window.print()">{% trans "Imprimer" %}</button>
  </div>

  {% if periode and classe_id %}
  <div class="table-responsive">
    <table class="table table-bordered">
      <thead>
        <tr>
          <th class="col-num">#</th>
          <th class="col-eleve">{% trans "Élève" %}</th>
          <th class="col-classe">{% trans "La liste des classes" %}</th>

          {% for mo in months %}
            <th style="min-width:110px;text-align:center">{{ mo.label }}</th>
          {% endfor %}

          <th style="min-width:90px;text-align:center">{% trans "Total" %}</th>
          <th style="min-width:90px;text-align:center">{% trans "AJ" %}</th>
        </tr>
      </thead>

      <tbody>
        {% for r in rows %}
          <tr>
            <td><strong>{{ r.i }}</strong></td>
            <td style="font-weight:800;text-transform:uppercase">{{ r.eleve.nom }}</td>
            <td>{{ r.classe_label }}</td>

            {% for v in r.vals %}
              <td style="text-align:center">{{ v }}</td>
            {% endfor %}

            <td style="text-align:center;font-weight:900">{{ r.total }}</td>
            <td style="text-align:center;font-weight:900">{{ r.aj }}</td>
          </tr>
        {% empty %}
          <tr>
            <td colspan="30" class="text-center text-muted py-4">{% trans "Aucune donnée." %}</td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  {% else %}
    <div class="text-muted py-3">
      {% trans "Choisis Niveau, Classe et Période puis clique sur Filtrer." %}
    </div>
  {% endif %}
</div>

<script>
(function(){
  const niveau = document.getElementById("niveauSelect");
  const classe = document.getElementById("classeSelect");
  if(!niveau || !classe) return;

  function filterClasses(){
    const niv = niveau.value;
    let hasSelected = false;

    [...classe.options].forEach((opt, idx) => {
      if(idx === 0) return;
      const ok = !niv || opt.dataset.niveau === niv;
      opt.hidden = !ok;
      if(opt.selected && !ok) opt.selected = false;
      if(opt.selected && ok) hasSelected = true;
    });

    if(!hasSelected) classe.value = "";
  }

  niveau.addEventListener("change", filterClasses);
  filterClasses();
})();
</script>

{% endblock %}
