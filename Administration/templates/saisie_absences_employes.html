{% extends "base.html" %}
{% block title%} Absences des employés {% endblock %}
{% block main %}

<style>
  .card-soft{border-radius:14px;}
  .btn-filter{border:0;}
  .pill{border-radius:999px;padding:.12rem .6rem;font-weight:600;font-size:.78rem}
  .pill-present{background:#1f9d55;color:#fff;}
  .pill-absence{background:#dc3545;color:#fff;}
  .pill-retard{background:#ffc107;color:#111;}
  .motif-input{min-width:260px;}
</style>

<div class="container-fluid py-3">

  <div class="mb-3">
    <h5 class="text-uppercase fw-bold">Saisie des absences des employés (EDT)</h5>
  </div>

  <!-- ✅ FILTRE (avec heures) -->
  <div class="card card-soft shadow-sm mb-3">
    <div class="card-body">
      <form method="get" class="row g-3 align-items-end">

        <div class="col-md-3">
          <label class="form-label fw-semibold">Employé</label>
          <select name="emp" class="form-select">
            <option value="">Tous les employés</option>
            {% for e in emps_select %}
              <option value="{{ e.id }}" {% if emp_id == e.id|stringformat:"s" %}selected{% endif %}>
                {{ e.nom_complet }}
              </option>
            {% endfor %}
          </select>
        </div>

        <div class="col-md-3">
          <label class="form-label fw-semibold">Date</label>
          <input type="date" name="date" class="form-control" value="{{ date_value }}">
        </div>

        <div class="col-md-2">
          <label class="form-label fw-semibold">À partir</label>
          <input type="time" name="h_debut" class="form-control" value="{{ h_debut }}">
        </div>

        <div class="col-md-2">
          <label class="form-label fw-semibold">Jusqu'à</label>
          <input type="time" name="h_fin" class="form-control" value="{{ h_fin }}">
        </div>

        <div class="col-md-2">
          <button class="btn btn-filter btn-success text-white w-100 py-2 fw-semibold" type="submit">
            Filtrer
          </button>
        </div>

      </form>
    </div>
  </div>

  <!-- ✅ TABLEAU -->
  <form method="post">
    {% csrf_token %}
    <input type="hidden" name="date" value="{{ date_value }}">
    <input type="hidden" name="h_debut" value="{{ h_debut }}">
    <input type="hidden" name="h_fin" value="{{ h_fin }}">

    <div class="card card-soft shadow-sm">
      <div class="card-body">

        <div class="table-responsive">
          <table class="table align-middle mb-0">
            <thead class="table-light">
              <tr>
                <th style="width:80px;">ID</th>
                <th>Nom</th>
                <th style="min-width:320px;">Statut</th>
                <th>Motif</th>
              </tr>
            </thead>

            <tbody>
              {% for row in rows %}
                {% with e=row.e a=row.a %}
                <tr>
                  <td class="fw-semibold">{{ e.id }}</td>
                  <td>
                    <div class="fw-semibold">{{ e.nom_complet }}</div>
                  </td>

                  <td>
                    {% with current=a.statut|default:"present" %}
                    <div class="d-flex align-items-center gap-3 flex-wrap">

                      <label class="d-flex align-items-center gap-2">
                        <input class="form-check-input" type="radio"
                               name="statut_{{ e.id }}" value="present"
                               {% if current == "present" %}checked{% endif %}>
                        <span class="pill pill-present">Présent</span>
                      </label>

                      <label class="d-flex align-items-center gap-2">
                        <input class="form-check-input" type="radio"
                               name="statut_{{ e.id }}" value="absence"
                               {% if current == "absence" %}checked{% endif %}>
                        <span class="pill pill-absence">Absence</span>
                      </label>

                      <label class="d-flex align-items-center gap-2">
                        <input class="form-check-input" type="radio"
                               name="statut_{{ e.id }}" value="retard"
                               {% if current == "retard" %}checked{% endif %}>
                        <span class="pill pill-retard">Retard</span>
                      </label>

                      <label class="d-flex align-items-center gap-2 ms-2">
                        <input class="form-check-input" type="checkbox"
                               name="justifiee_{{ e.id }}" value="1"
                               {% if a and a.justifiee %}checked{% endif %}>
                        <span class="btn btn-sm btn-primary py-0">Justifier</span>
                      </label>

                    </div>
                    {% endwith %}
                  </td>

                  <td>
                    <input class="form-control motif-input"
                           name="motif_{{ e.id }}"
                           value="{% if a %}{{ a.motif }}{% endif %}"
                           placeholder="Motif (optionnel)">
                  </td>
                </tr>
                {% endwith %}
              {% empty %}
                <tr>
                  <td colspan="4" class="text-center text-muted py-4">
                    Aucun employé trouvé.
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

        <div class="d-flex justify-content-end mt-3">
          <button class="btn btn-dark px-4" type="submit">Enregistrer</button>
        </div>

      </div>
    </div>

  </form>

</div>

{% endblock %}
